<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¦‹ç©UI</title>
  <link rel="stylesheet" href="static/css/style.css" />
  <script>
    // Azure Functions (estimate-agent-backend)
    window.ENHANCE_BASE = 'https://estimate-api-cli.azurewebsites.net';
    window.DEBUG = false; // æœ¬ç•ªã¯ falseã€PoCèª¿æŸ»æ™‚ã¯ true
  </script>
</head>

<body>
  <div class="l-container-800">
    <h1 class="u-mb-16">AIè¦‹ç©UI</h1>

    <form id="f" class="u-mt-8">
      <div>
        <label>æ¡ˆä»¶å</label><br />
        <input name="project_name" value="ãƒ†ã‚¹ãƒˆæ¡ˆä»¶" required />
      </div>
      <div>
        <label>è¦ç´„</label><br />
        <input name="summary" value="UIæ”¹å–„" required />
      </div>
      <div>
        <label>ç¯„å›²</label><br />
        <input name="scope" value="è¦ä»¶ã€œå®Ÿè£…" required />
      </div>
      <div>
        <label>ç”»é¢æ•°</label><br />
        <input name="screen_count" type="number" value="12" min="1" required />
      </div>
      <div>
        <label>é›£æ˜“åº¦</label><br />
        <select name="complexity">
          <option>low</option>
          <option selected>medium</option>
          <option>high</option>
        </select>
      </div>

      <button type="submit" class="u-mt-16">è¦‹ç©ã‚‹</button>
    </form>

    <hr />
    <div id="status" class="u-mb-8"></div>
    <div id="summary" class="u-mb-16"></div>
    <!-- AIè£œæ­£ï¼ˆå‚è€ƒï¼‰ -->
    <details id="ai-adjustment" class="u-mt-8" hidden>
      <summary>AIè£œæ­£æ¡ˆï¼ˆå‚è€ƒãƒ»è‡ªå‹•ç”Ÿæˆï¼‰</summary>
      <div class="doc--8px u-mt-8">
        <p><strong>è£œæ­£å¾Œç›®å®‰ï¼š</strong><span id="ai-adjusted"></span></p>
        <ul id="ai-reasons"></ul>
        <p class="u-mt-8"><small>â€»å‚è€ƒæƒ…å ±ï¼ˆæœ€çµ‚åˆ¤æ–­ã¯æ‹…å½“è€…ï¼‰</small></p>
      </div>
    </details>
    <div id="out" class="doc--8px u-mt-8"></div>

    <div id="details" class="u-mt-16" style="display: none">
      <details class="u-mb-8">
        <summary style="cursor: pointer; font-weight: bold; padding: 8px 0">
          âš ï¸ æ³¨æ„äº‹é … (Warnings)
        </summary>
        <div id="warnings" class="u-mt-8" style="padding-left: 16px; color: #666"></div>
      </details>
      <details class="u-mb-8">
        <summary style="cursor: pointer; font-weight: bold; padding: 8px 0">
          ğŸ“‹ å‰ææ¡ä»¶ (Assumptions)
        </summary>
        <div id="assumptions" class="u-mt-8" style="padding-left: 16px; color: #666"></div>
      </details>
    </div>

    <footer id="footer" class="u-mt-16"
      style="padding-top: 16px; border-top: 1px solid #ddd; color: #888; font-size: 0.875rem"></footer>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('f');
        const out = document.getElementById('out');
        const statusEl = document.getElementById('status');
        const summaryEl = document.getElementById('summary');

        // Single-source override: set window.AGENT_BASE via inline script when needed.
        // Auto-detect Codespace environment; fallback to localhost
        const AGENT_BASE =
          window.AGENT_BASE ??
          (() => {
            const hostname = window.location.hostname;

            // Codespacesï¼ˆHTTPSå¿…é ˆï¼‰
            if (hostname.includes('github.dev')) {
              return `https://${hostname.replace('-8002', '-8001')}`;
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
            return 'http://127.0.0.1:8001';
          })();

        // Azure Functionsï¼ˆAIè£œæ­£ï¼‰ã®ãƒ™ãƒ¼ã‚¹URL
        // window.ENHANCE_BASE ã§ä¸Šæ›¸ãå¯èƒ½ï¼ˆæœ¬ç•ª: https://estimate-api-cli.azurewebsites.netï¼‰
        const ENHANCE_BASE =
          window.ENHANCE_BASE ??
          (() => {
            const h = location.hostname;
            if (h.includes('github.dev')) return `https://${h.replace('-8002', '-7071')}`;
            return 'http://127.0.0.1:7071';
          })();

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        const DEBUG = !!window.DEBUG;

        function logErr(...args) {
          if (DEBUG) console.error(...args);
          else console.warn(...args);
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        function formatJPY(amount) {
          const num = Math.trunc(Number(amount));
          if (!Number.isFinite(num)) return '-';
          return new Intl.NumberFormat('ja-JP').format(num);
        }

        async function callAIEnhance({ project_name, summary, scope, coreResult }) {
          const url = `${ENHANCE_BASE}/api/enhance_estimate`;
          try {
            const res = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ project_name, summary, scope, core_result: coreResult }),
            });
            const bodyText = await res.text();
            if (!res.ok) {
              logErr('[enhance_estimate] failed', { status: res.status, url, body: bodyText });
              throw new Error(`enhance_estimate failed: ${res.status}`);
            }
            return JSON.parse(bodyText);
          } catch (err) {
            logErr('[enhance_estimate] error', { url, error: err.message });
            throw err;
          }
        }

        function renderAIHtml(ai) {
          if (!ai || ai.status !== 'ok') {
            return '';
          }

          const adjusted = ai.adjustment && ai.adjustment.adjusted_amount;
          const adjustedStr = typeof adjusted === 'number' ? `Â¥${formatJPY(adjusted)}` : '-';

          const reasons = (ai.adjustment?.reasons || [])
            .map((r) => `<li>${escapeHtml(r)}</li>`)
            .join('');

          return `
                        <details open>
                            <summary>AIè£œæ­£æ¡ˆï¼ˆå‚è€ƒãƒ»è‡ªå‹•ç”Ÿæˆï¼‰</summary>
                            <div class="doc--8px u-mt-8">
                                <p><strong>è£œæ­£å¾Œç›®å®‰ï¼š</strong><span>${adjustedStr}</span></p>
                                ${reasons ? `<ul>${reasons}</ul>` : ''}
                                <p class="u-mt-8"><small>â€»å‚è€ƒæƒ…å ±ï¼ˆæœ€çµ‚åˆ¤æ–­ã¯æ‹…å½“è€…ï¼‰</small></p>
                            </div>
                        </details>
                    `;
        }

        function setAIState(state, html = '') {
          const box = document.getElementById('ai-adjustment');
          if (!box) return;
          box.hidden = false;

          if (state === 'loading') {
            box.innerHTML = "<div class='u-mt-8'>AIè£œæ­£ã‚’å–å¾—ä¸­â€¦</div>";
          } else if (state === 'ok') {
            box.innerHTML = html;
          } else if (state === 'fail') {
            box.innerHTML = `<div class='u-mt-8'>AIè£œæ­£ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¦‚ç®—è¦‹ç©ã¯è¡¨ç¤ºã§ãã¾ã™ï¼‰</div>${html ? `<div class="u-mt-8"><small style="color: #888;">${escapeHtml(html)}</small></div>` : ''}`;
          }
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          statusEl.textContent = 'å…¥åŠ›ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚è¦‹ç©ã‚‚ã‚Šç”Ÿæˆä¸­â€¦';
          out.textContent = 'è¨ˆç®—ä¸­...';
          summaryEl.textContent = '';
          const payload = Object.fromEntries(new FormData(form).entries());
          payload.screen_count = Number(payload.screen_count);

          const url = `${AGENT_BASE}/estimate`;
          console.log('[estimate] url:', url, 'payload:', payload);

          try {
            const res = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            console.log('[estimate] response status:', res.status);
            const bodyText = await res.text();
            let data = null;
            try {
              data = JSON.parse(bodyText);
            } catch (e) {
              console.error('[estimate] invalid JSON:', bodyText);
              statusEl.textContent = `Error ${res.status}: invalid JSON`;
              out.textContent = bodyText;
              return;
            }

            // Expected schema:
            // { status: "ok"|"error", estimated_amount: number, currency: "JPY", message: string|null }
            console.log('[estimate] response json:', data);

            if (!res.ok || data.status !== 'ok') {
              // ãƒ“ã‚¸ãƒã‚¹å‘ã‘ã®ç°¡æ½”ãªæ–‡è¨€ã®ã¿è¡¨ç¤º
              statusEl.textContent = 'ç¾åœ¨ã€æ¦‚ç®—ã‚’ç®—å‡ºã§ãã¾ã›ã‚“';
              summaryEl.textContent = ''; // éè¡¨ç¤ºæ‰±ã„
              out.classList.remove('doc--8px'); // å¤±æ•—æ™‚ã¯é©ç”¨ã—ãªã„
              out.textContent = '';
              return;
            }

            statusEl.textContent = 'è¦‹ç©ã‚‚ã‚Šç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
            // é‡‘é¡ã¯å††ï¼ˆæ•´æ•°ï¼‰ã§è¡¨ç¤ºã—ã€é€šè²¨ã‚³ãƒ¼ãƒ‰ã¯å‡ºã•ãªã„ï¼ˆJPYå›ºå®šå‰æï¼‰
            const amountNum = Math.trunc(Number(data.estimated_amount));
            if (Number.isFinite(amountNum)) {
              const formatter = new Intl.NumberFormat('ja-JP');
              const amountStr = `Â¥${formatter.format(amountNum)}`;
              // è¦‹å‡ºã—ã¨è£œè¶³æ–‡ã‚’å«ã‚ã¦è¡¨ç¤º
              summaryEl.innerHTML = `
                            <div class="l-stack-8">
                                <div class="u-mb-8">æ¦‚ç®—è¦‹ç©</div>
                                <div class="u-mb-8">${amountStr}</div>
                                <div style="font-size: 0.875rem; color: #555;">â€»ã‚ãã¾ã§ç›®å®‰ã§ã™</div>
                            </div>
                        `;
            } else {
              // æœªç®—å‡ºã¯éè¡¨ç¤º
              summaryEl.textContent = '';
            }
            out.classList.add('doc--8px');
            out.innerHTML = data.message || ''; // HTML rationale

            // warnings/assumptions ã‚’è¡¨ç¤º
            const detailsEl = document.getElementById('details');
            const warningsEl = document.getElementById('warnings');
            const assumptionsEl = document.getElementById('assumptions');

            if (data.warnings && data.warnings.length > 0) {
              warningsEl.innerHTML =
                '<ul>' +
                data.warnings.map((w) => `<li class="u-mb-8">${w}</li>`).join('') +
                '</ul>';
              detailsEl.style.display = 'block';
            } else {
              warningsEl.textContent = 'ãªã—';
            }

            if (data.assumptions && data.assumptions.length > 0) {
              assumptionsEl.innerHTML =
                '<ul>' +
                data.assumptions.map((a) => `<li class="u-mb-8">${a}</li>`).join('') +
                '</ul>';
              detailsEl.style.display = 'block';
            } else {
              assumptionsEl.textContent = 'ãªã—';
            }

            // config_version ã‚’ãƒ•ãƒƒã‚¿ãƒ¼ã«è¡¨ç¤º
            const footerEl = document.getElementById('footer');
            if (data.config_version) {
              footerEl.textContent = `Config Version: ${data.config_version}`;
            }
            // --- AIè£œæ­£ï¼ˆå‚è€ƒï¼‰å‘¼ã³å‡ºã— ---
            setAIState('loading');
            try {
              const coreResult = {
                status: data.status,
                estimated_amount: data.estimated_amount,
                currency: data.currency,
              };
              const ai = await callAIEnhance({
                project_name: payload.project_name,
                summary: payload.summary,
                scope: payload.scope,
                coreResult,
              });
              setAIState('ok', renderAIHtml(ai));
            } catch (err) {
              logErr('[enhance_estimate] AIè£œæ­£ã®å–å¾—ã«å¤±æ•—', err);
              setAIState('fail', String(err?.message || err));
            }
          } catch (err) {
            console.error('[estimate] error:', err);
            statusEl.textContent = `Fetch failed: ${err}`;
            out.textContent = '';
          }
        });
      });
    </script>
  </div>
</body>

</html>