<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è¦‹ç©UI</title>
    <link rel="stylesheet" href="static/css/style.css" />
</head>

<body>
    <div class="l-container-800">
        <h1 class="u-mb-16">AIè¦‹ç©UI</h1>

        <form id="f" class="u-mt-8">
            <div>
                <label>æ¡ˆä»¶å</label><br />
                <input name="project_name" value="ãƒ†ã‚¹ãƒˆæ¡ˆä»¶" required />
            </div>
            <div>
                <label>è¦ç´„</label><br />
                <input name="summary" value="UIæ”¹å–„" required />
            </div>
            <div>
                <label>ç¯„å›²</label><br />
                <input name="scope" value="è¦ä»¶ã€œå®Ÿè£…" required />
            </div>
            <div>
                <label>ç”»é¢æ•°</label><br />
                <input name="screen_count" type="number" value="12" min="1" required />
            </div>
            <div>
                <label>é›£æ˜“åº¦</label><br />
                <select name="complexity">
                    <option>low</option>
                    <option selected>medium</option>
                    <option>high</option>
                </select>
            </div>

            <button type="submit" class="u-mt-16">è¦‹ç©ã‚‹</button>
        </form>

        <hr />
        <div id="status" class="u-mb-8"></div>
        <div id="summary" class="u-mb-16"></div>
        <!-- AIè£œæ­£ï¼ˆå‚è€ƒï¼‰ -->
        <details id="ai-adjustment" class="u-mt-8" hidden>
            <summary>AIè£œæ­£æ¡ˆï¼ˆå‚è€ƒãƒ»è‡ªå‹•ç”Ÿæˆï¼‰</summary>
            <div class="doc--8px u-mt-8">
                <p><strong>è£œæ­£å¾Œç›®å®‰ï¼š</strong><span id="ai-adjusted"></span></p>
                <ul id="ai-reasons"></ul>
                <p class="u-mt-8"><small>â€»å‚è€ƒæƒ…å ±ï¼ˆæœ€çµ‚åˆ¤æ–­ã¯æ‹…å½“è€…ï¼‰</small></p>
            </div>
        </details>
        <div id="out" class="doc--8px u-mt-8"></div>

        <div id="details" class="u-mt-16" style="display:none;">
            <details class="u-mb-8">
                <summary style="cursor: pointer; font-weight: bold; padding: 8px 0;">âš ï¸ æ³¨æ„äº‹é … (Warnings)</summary>
                <div id="warnings" class="u-mt-8" style="padding-left: 16px; color: #666;"></div>
            </details>
            <details class="u-mb-8">
                <summary style="cursor: pointer; font-weight: bold; padding: 8px 0;">ğŸ“‹ å‰ææ¡ä»¶ (Assumptions)</summary>
                <div id="assumptions" class="u-mt-8" style="padding-left: 16px; color: #666;"></div>
            </details>
        </div>

        <footer id="footer" class="u-mt-16"
            style="padding-top: 16px; border-top: 1px solid #ddd; color: #888; font-size: 0.875rem;">
        </footer>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const form = document.getElementById("f");
                const out = document.getElementById("out");
                const statusEl = document.getElementById("status");
                const summaryEl = document.getElementById("summary");

                // Single-source override: set window.AGENT_BASE via inline script when needed.
                // Auto-detect Codespace environment; fallback to localhost
                const AGENT_BASE = window.AGENT_BASE ?? (() => {
                    const hostname = window.location.hostname;

                    // Codespacesï¼ˆHTTPSå¿…é ˆï¼‰
                    if (hostname.includes("github.dev")) {
                        return `https://${hostname.replace("-8002", "-8001")}`;
                    }

                    // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
                    return "http://127.0.0.1:8001";
                })();

                // Backendï¼ˆAIï¼‰ã®ãƒ™ãƒ¼ã‚¹URLï¼ˆCodespaces/ãƒ­ãƒ¼ã‚«ãƒ«ä¸¡å¯¾å¿œï¼‰
                const AI_BASE = (() => {
                    const h = location.hostname;
                    if (h.includes("github.dev")) return `https://${h.replace("-8002", "-7071")}`;
                    return "http://127.0.0.1:7071";
                })();

                async function callAIEnhance({ project_name, summary, scope, coreResult }) {
                    try {
                        const res = await fetch(`${AI_BASE}/api/enhance_estimate`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ project_name, summary, scope, core_result: coreResult })
                        });
                        if (!res.ok) return null;
                        return await res.json();
                    } catch {
                        return null; // AIå¤±æ•—ã§ã‚‚UIã¯å£Šã•ãªã„
                    }
                }

                function renderAI(ai) {
                    const box = document.getElementById("ai-adjustment");
                    if (!ai || ai.status !== "ok") {
                        box.hidden = true;
                        return;
                    }

                    const adjusted = ai.adjustment && ai.adjustment.adjusted_amount;
                    if (typeof adjusted === "number") {
                        document.getElementById("ai-adjusted").textContent = `Â¥${adjusted.toLocaleString("ja-JP")}`;
                    } else {
                        document.getElementById("ai-adjusted").textContent = "-";
                    }

                    const ul = document.getElementById("ai-reasons");
                    ul.innerHTML = "";
                    // è‹±èªã®å®šå‹æ–‡ã‚’æ—¥æœ¬èªã¸ç°¡æ˜“ç½®æ›
                    const simpleDict = {
                        "Insufficient information to suggest a higher multiplier.": "ä¿‚æ•°ã‚’ä¸Šã’ã‚‹ãŸã‚ã®æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚",
                        "Project details are generic and do not indicate specific risks or complexities.": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°ãŒä¸€èˆ¬çš„ã§ã€ç‰¹æœ‰ã®ãƒªã‚¹ã‚¯ã‚„è¤‡é›‘æ€§ã¯ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
                        "Reusing existing assets reduces effort.": "æ—¢å­˜è³‡ç”£ã®å†åˆ©ç”¨ã«ã‚ˆã‚Šå·¥æ•°ãŒå‰Šæ¸›ã•ã‚Œã¾ã™ã€‚",
                        "Scope clarification improves efficiency.": "ã‚¹ã‚³ãƒ¼ãƒ—ã®æ˜ç¢ºåŒ–ã«ã‚ˆã‚ŠåŠ¹ç‡ãŒå‘ä¸Šã—ã¾ã™ã€‚",
                        "Leverage existing components to reduce cost.": "æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ´»ç”¨ã§ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã—ã¾ã™ã€‚",
                        "No significant external dependencies identified.": "é‡å¤§ãªå¤–éƒ¨ä¾å­˜ã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
                    };
                    (ai.adjustment?.reasons || []).forEach(r => {
                        const jp = simpleDict[r?.trim?.()] || r;
                        const li = document.createElement("li");
                        li.textContent = jp;
                        ul.appendChild(li);
                    });

                    box.hidden = false;
                    box.open = false; // åˆæœŸã¯é–‰ã˜ã‚‹
                }

                form.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    statusEl.textContent = "å…¥åŠ›ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚è¦‹ç©ã‚‚ã‚Šç”Ÿæˆä¸­â€¦";
                    out.textContent = "è¨ˆç®—ä¸­...";
                    summaryEl.textContent = "";
                    const payload = Object.fromEntries(new FormData(form).entries());
                    payload.screen_count = Number(payload.screen_count);

                    const url = `${AGENT_BASE}/estimate`;
                    console.log("[estimate] url:", url, "payload:", payload);

                    try {
                        const res = await fetch(url, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload),
                        });
                        console.log("[estimate] response status:", res.status);
                        const bodyText = await res.text();
                        let data = null;
                        try {
                            data = JSON.parse(bodyText);
                        } catch (e) {
                            console.error("[estimate] invalid JSON:", bodyText);
                            statusEl.textContent = `Error ${res.status}: invalid JSON`;
                            out.textContent = bodyText;
                            return;
                        }

                        // Expected schema:
                        // { status: "ok"|"error", estimated_amount: number, currency: "JPY", message: string|null }
                        console.log("[estimate] response json:", data);

                        if (!res.ok || data.status !== "ok") {
                            // ãƒ“ã‚¸ãƒã‚¹å‘ã‘ã®ç°¡æ½”ãªæ–‡è¨€ã®ã¿è¡¨ç¤º
                            statusEl.textContent = "ç¾åœ¨ã€æ¦‚ç®—ã‚’ç®—å‡ºã§ãã¾ã›ã‚“";
                            summaryEl.textContent = ""; // éè¡¨ç¤ºæ‰±ã„
                            out.classList.remove("doc--8px"); // å¤±æ•—æ™‚ã¯é©ç”¨ã—ãªã„
                            out.textContent = "";
                            return;
                        }

                        statusEl.textContent = "è¦‹ç©ã‚‚ã‚Šç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
                        // é‡‘é¡ã¯å††ï¼ˆæ•´æ•°ï¼‰ã§è¡¨ç¤ºã—ã€é€šè²¨ã‚³ãƒ¼ãƒ‰ã¯å‡ºã•ãªã„ï¼ˆJPYå›ºå®šå‰æï¼‰
                        const amountNum = Math.trunc(Number(data.estimated_amount));
                        if (Number.isFinite(amountNum)) {
                            const formatter = new Intl.NumberFormat("ja-JP");
                            const amountStr = `Â¥${formatter.format(amountNum)}`;
                            // è¦‹å‡ºã—ã¨è£œè¶³æ–‡ã‚’å«ã‚ã¦è¡¨ç¤º
                            summaryEl.innerHTML = `
                            <div class="l-stack-8">
                                <div class="u-mb-8">æ¦‚ç®—è¦‹ç©</div>
                                <div class="u-mb-8">${amountStr}</div>
                                <div style="font-size: 0.875rem; color: #555;">â€»ã‚ãã¾ã§ç›®å®‰ã§ã™</div>
                            </div>
                        `;
                        } else {
                            // æœªç®—å‡ºã¯éè¡¨ç¤º
                            summaryEl.textContent = "";
                        }
                        out.classList.add("doc--8px");
                        out.innerHTML = data.message || ""; // HTML rationale

                        // warnings/assumptions ã‚’è¡¨ç¤º
                        const detailsEl = document.getElementById("details");
                        const warningsEl = document.getElementById("warnings");
                        const assumptionsEl = document.getElementById("assumptions");

                        if (data.warnings && data.warnings.length > 0) {
                            warningsEl.innerHTML = "<ul>" + data.warnings.map(w => `<li class="u-mb-8">${w}</li>`).join("") + "</ul>";
                            detailsEl.style.display = "block";
                        } else {
                            warningsEl.textContent = "ãªã—";
                        }

                        if (data.assumptions && data.assumptions.length > 0) {
                            assumptionsEl.innerHTML = "<ul>" + data.assumptions.map(a => `<li class="u-mb-8">${a}</li>`).join("") + "</ul>";
                            detailsEl.style.display = "block";
                        } else {
                            assumptionsEl.textContent = "ãªã—";
                        }

                        // config_version ã‚’ãƒ•ãƒƒã‚¿ãƒ¼ã«è¡¨ç¤º
                        const footerEl = document.getElementById("footer");
                        if (data.config_version) {
                            footerEl.textContent = `Config Version: ${data.config_version}`;
                        }
                        // --- AIè£œæ­£ï¼ˆå‚è€ƒï¼‰å‘¼ã³å‡ºã— ---
                        const coreResult = { status: data.status, estimated_amount: data.estimated_amount, currency: data.currency };
                        const ai = await callAIEnhance({
                            project_name: payload.project_name,
                            summary: payload.summary,
                            scope: payload.scope,
                            coreResult
                        });
                        renderAI(ai);

                    } catch (err) {
                        console.error("[estimate] error:", err);
                        statusEl.textContent = `Fetch failed: ${err}`;
                        out.textContent = "";
                    }
                });
            });
        </script>
    </div>
</body>

</html>