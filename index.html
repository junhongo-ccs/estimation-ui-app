<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è¦‹ç©UI</title>
    <link rel="stylesheet" href="static/css/style.css" />
</head>

<body>
    <h1>AIè¦‹ç©UI</h1>

    <form id="f">
        <div>
            <label>æ¡ˆä»¶å</label><br />
            <input name="project_name" value="ãƒ†ã‚¹ãƒˆæ¡ˆä»¶" required />
        </div>
        <div>
            <label>è¦ç´„</label><br />
            <input name="summary" value="UIæ”¹å–„" required />
        </div>
        <div>
            <label>ç¯„å›²</label><br />
            <input name="scope" value="è¦ä»¶ã€œå®Ÿè£…" required />
        </div>
        <div>
            <label>ç”»é¢æ•°</label><br />
            <input name="screen_count" type="number" value="12" min="1" required />
        </div>
        <div>
            <label>é›£æ˜“åº¦</label><br />
            <select name="complexity">
                <option>low</option>
                <option selected>medium</option>
                <option>high</option>
            </select>
        </div>

        <button type="submit">è¦‹ç©ã‚‹</button>
    </form>

    <hr />
    <div id="status" class="u-mb-8"></div>
    <div id="summary" class="u-mb-16"></div>
    <div id="out" class="doc--8px u-mt-8"></div>

    <div id="details" class="u-mt-16" style="display:none;">
        <details class="u-mb-8">
            <summary style="cursor: pointer; font-weight: bold; padding: 8px 0;">âš ï¸ æ³¨æ„äº‹é … (Warnings)</summary>
            <div id="warnings" class="u-mt-8" style="padding-left: 16px; color: #666;"></div>
        </details>
        <details class="u-mb-8">
            <summary style="cursor: pointer; font-weight: bold; padding: 8px 0;">ğŸ“‹ å‰ææ¡ä»¶ (Assumptions)</summary>
            <div id="assumptions" class="u-mt-8" style="padding-left: 16px; color: #666;"></div>
        </details>
    </div>

    <footer id="footer" class="u-mt-16"
        style="padding-top: 16px; border-top: 1px solid #ddd; color: #888; font-size: 0.875rem;">
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("f");
            const out = document.getElementById("out");
            const statusEl = document.getElementById("status");
            const summaryEl = document.getElementById("summary");

            // Single-source override: set window.AGENT_BASE via inline script when needed.
            // Auto-detect Codespace environment; fallback to localhost
            const AGENT_BASE = window.AGENT_BASE ?? (() => {
                const hostname = window.location.hostname;

                // Codespacesï¼ˆHTTPSå¿…é ˆï¼‰
                if (hostname.includes("github.dev")) {
                    return `https://${hostname.replace("-8002", "-8001")}`;
                }

                // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
                return "http://127.0.0.1:8001";
            })();

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                statusEl.textContent = "å…¥åŠ›ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚è¦‹ç©ã‚‚ã‚Šç”Ÿæˆä¸­â€¦";
                out.textContent = "è¨ˆç®—ä¸­...";
                summaryEl.textContent = "";
                const payload = Object.fromEntries(new FormData(form).entries());
                payload.screen_count = Number(payload.screen_count);

                const url = `${AGENT_BASE}/estimate`;
                console.log("[estimate] url:", url, "payload:", payload);

                try {
                    const res = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    console.log("[estimate] response status:", res.status);
                    const bodyText = await res.text();
                    let data = null;
                    try {
                        data = JSON.parse(bodyText);
                    } catch (e) {
                        console.error("[estimate] invalid JSON:", bodyText);
                        statusEl.textContent = `Error ${res.status}: invalid JSON`;
                        out.textContent = bodyText;
                        return;
                    }

                    // Expected schema:
                    // { status: "ok"|"error", estimated_amount: number, currency: "JPY", message: string|null }
                    console.log("[estimate] response json:", data);

                    if (!res.ok || data.status !== "ok") {
                        // ãƒ“ã‚¸ãƒã‚¹å‘ã‘ã®ç°¡æ½”ãªæ–‡è¨€ã®ã¿è¡¨ç¤º
                        statusEl.textContent = "ç¾åœ¨ã€æ¦‚ç®—ã‚’ç®—å‡ºã§ãã¾ã›ã‚“";
                        summaryEl.textContent = ""; // éè¡¨ç¤ºæ‰±ã„
                        out.classList.remove("doc--8px"); // å¤±æ•—æ™‚ã¯é©ç”¨ã—ãªã„
                        out.textContent = "";
                        return;
                    }

                    statusEl.textContent = "è¦‹ç©ã‚‚ã‚Šç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
                    // é‡‘é¡ã¯å††ï¼ˆæ•´æ•°ï¼‰ã§è¡¨ç¤ºã—ã€é€šè²¨ã‚³ãƒ¼ãƒ‰ã¯å‡ºã•ãªã„ï¼ˆJPYå›ºå®šå‰æï¼‰
                    const amountNum = Math.trunc(Number(data.estimated_amount));
                    if (Number.isFinite(amountNum)) {
                        const formatter = new Intl.NumberFormat("ja-JP");
                        const amountStr = `Â¥${formatter.format(amountNum)}`;
                        // è¦‹å‡ºã—ã¨è£œè¶³æ–‡ã‚’å«ã‚ã¦è¡¨ç¤º
                        summaryEl.innerHTML = `
                            <div class="l-stack-8">
                                <div class="u-mb-8">æ¦‚ç®—è¦‹ç©</div>
                                <div class="u-mb-8">${amountStr}</div>
                                <div style="font-size: 0.875rem; color: #555;">â€»ã‚ãã¾ã§ç›®å®‰ã§ã™</div>
                            </div>
                        `;
                    } else {
                        // æœªç®—å‡ºã¯éè¡¨ç¤º
                        summaryEl.textContent = "";
                    }
                    out.classList.add("doc--8px");
                    out.innerHTML = data.message || ""; // HTML rationale

                    // warnings/assumptions ã‚’è¡¨ç¤º
                    const detailsEl = document.getElementById("details");
                    const warningsEl = document.getElementById("warnings");
                    const assumptionsEl = document.getElementById("assumptions");

                    if (data.warnings && data.warnings.length > 0) {
                        warningsEl.innerHTML = "<ul>" + data.warnings.map(w => `<li class="u-mb-8">${w}</li>`).join("") + "</ul>";
                        detailsEl.style.display = "block";
                    } else {
                        warningsEl.textContent = "ãªã—";
                    }

                    if (data.assumptions && data.assumptions.length > 0) {
                        assumptionsEl.innerHTML = "<ul>" + data.assumptions.map(a => `<li class="u-mb-8">${a}</li>`).join("") + "</ul>";
                        detailsEl.style.display = "block";
                    } else {
                        assumptionsEl.textContent = "ãªã—";
                    }

                    // config_version ã‚’ãƒ•ãƒƒã‚¿ãƒ¼ã«è¡¨ç¤º
                    const footerEl = document.getElementById("footer");
                    if (data.config_version) {
                        footerEl.textContent = `Config Version: ${data.config_version}`;
                    }
                } catch (err) {
                    console.error("[estimate] error:", err);
                    statusEl.textContent = `Fetch failed: ${err}`;
                    out.textContent = "";
                }
            });
        });
    </script>
</body>

</html>